# =============================================================================
# Apache VirtualHost Configuration - Development/Test Server
# =============================================================================
# File: /etc/apache2/sites-available/mec-previsioni-dev.conf
#
# Architettura: Apache (Reverse Proxy) -> Gunicorn -> Flask
#
# Attivazione:
#   sudo a2ensite mec-previsioni-dev
#   sudo a2enmod proxy proxy_http headers
#   sudo systemctl reload apache2
# =============================================================================

<VirtualHost *:80>
    ServerName dev.mec-previsioni.local
    ServerAlias www.dev.mec-previsioni.local

    ServerAdmin webmaster@yourdomain.com

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/mec-previsioni-dev-error.log
    CustomLog ${APACHE_LOG_DIR}/mec-previsioni-dev-access.log combined
    LogLevel warn

    # =============================================================================
    # Reverse Proxy verso Gunicorn (localhost:5010)
    # =============================================================================

    ProxyPreserveHost On
    ProxyRequests Off

    # Proxy pass per applicazione Flask
    ProxyPass / http://127.0.0.1:5010/
    ProxyPassReverse / http://127.0.0.1:5010/

    # Headers per passare informazioni al backend
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # =============================================================================
    # Static Files (Opzionale - per performance)
    # =============================================================================
    # Serve static files direttamente da Apache invece che passare a Gunicorn

    Alias /static /var/www/mec-previsioni/static
    <Directory /var/www/mec-previsioni/static>
        Require all granted
        Options -Indexes

        # Cache headers per static files
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/png "access plus 1 month"
            ExpiresByType image/jpeg "access plus 1 month"
            ExpiresByType text/css "access plus 1 week"
            ExpiresByType application/javascript "access plus 1 week"
        </IfModule>
    </Directory>

    # =============================================================================
    # Security Headers
    # =============================================================================

    # Previene clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Previene MIME-type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # =============================================================================
    # Timeouts
    # =============================================================================

    # Aumenta timeout per operazioni lunghe (es. calcolo previsioni)
    ProxyTimeout 300
    TimeOut 300

</VirtualHost>

# =============================================================================
# HTTPS VirtualHost (Development con SSL self-signed)
# =============================================================================
# Decommentare dopo aver generato certificati SSL self-signed:
#   sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#     -keyout /etc/ssl/private/mec-dev-selfsigned.key \
#     -out /etc/ssl/certs/mec-dev-selfsigned.crt

# <IfModule mod_ssl.c>
# <VirtualHost *:443>
#     ServerName dev.mec-previsioni.local
#     ServerAdmin webmaster@yourdomain.com
#
#     # SSL Configuration
#     SSLEngine on
#     SSLCertificateFile /etc/ssl/certs/mec-dev-selfsigned.crt
#     SSLCertificateKeyFile /etc/ssl/private/mec-dev-selfsigned.key
#
#     # Logging
#     ErrorLog ${APACHE_LOG_DIR}/mec-previsioni-dev-ssl-error.log
#     CustomLog ${APACHE_LOG_DIR}/mec-previsioni-dev-ssl-access.log combined
#
#     # Reverse Proxy
#     ProxyPreserveHost On
#     ProxyRequests Off
#     ProxyPass / http://127.0.0.1:5010/
#     ProxyPassReverse / http://127.0.0.1:5010/
#
#     # Headers HTTPS
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Port "443"
#
#     # Static files
#     Alias /static /var/www/mec-previsioni/static
#     <Directory /var/www/mec-previsioni/static>
#         Require all granted
#         Options -Indexes
#     </Directory>
#
#     # Security Headers
#     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#     Header always set X-Frame-Options "SAMEORIGIN"
#     Header always set X-Content-Type-Options "nosniff"
#
# </VirtualHost>
# </IfModule>
