# =============================================================================
# Apache VirtualHost Configuration - Production Server
# =============================================================================
# File: /etc/apache2/sites-available/mec-previsioni-prod.conf
#
# Architettura: Load Balancer -> Apache (Reverse Proxy) -> Gunicorn -> Flask
#
# Attivazione:
#   sudo a2ensite mec-previsioni-prod
#   sudo a2enmod proxy proxy_http proxy_balancer lbmethod_byrequests headers ssl
#   sudo systemctl reload apache2
# =============================================================================

<VirtualHost *:80>
    ServerName mec-previsioni.yourdomain.com
    ServerAlias www.mec-previsioni.yourdomain.com

    ServerAdmin webmaster@yourdomain.com

    # Redirect HTTP to HTTPS
    Redirect permanent / https://mec-previsioni.yourdomain.com/

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/mec-previsioni-prod-error.log
    CustomLog ${APACHE_LOG_DIR}/mec-previsioni-prod-access.log combined
</VirtualHost>

# =============================================================================
# HTTPS VirtualHost - Production
# =============================================================================

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName mec-previsioni.yourdomain.com
    ServerAlias www.mec-previsioni.yourdomain.com

    ServerAdmin webmaster@yourdomain.com

    # =============================================================================
    # SSL Configuration (Let's Encrypt o certificato commerciale)
    # =============================================================================

    SSLEngine on

    # Let's Encrypt certificates (esempio)
    SSLCertificateFile /etc/letsencrypt/live/mec-previsioni.yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/mec-previsioni.yourdomain.com/privkey.pem

    # SSL Security Best Practices
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off

    # =============================================================================
    # Logging
    # =============================================================================

    ErrorLog ${APACHE_LOG_DIR}/mec-previsioni-prod-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/mec-previsioni-prod-ssl-access.log combined
    LogLevel warn

    # =============================================================================
    # Reverse Proxy con Load Balancing
    # =============================================================================
    # Configurazione per più workers Gunicorn su porte diverse

    ProxyPreserveHost On
    ProxyRequests Off

    # Definisci balancer con più backend workers
    <Proxy balancer://mec_cluster>
        # Worker 1
        BalancerMember http://127.0.0.1:5010 route=worker1

        # Worker 2 (opzionale, decommentare se necessario)
        # BalancerMember http://127.0.0.1:5011 route=worker2

        # Worker 3 (opzionale)
        # BalancerMember http://127.0.0.1:5012 route=worker3

        # Load balancing algorithm: byrequests, bytraffic, bybusyness
        ProxySet lbmethod=byrequests

        # Sticky sessions (opzionale, se necessarie sessioni persistenti)
        # ProxySet stickysession=ROUTEID
    </Proxy>

    # Proxy pass all requests to balancer
    ProxyPass / balancer://mec_cluster/
    ProxyPassReverse / balancer://mec_cluster/

    # Headers per passare informazioni al backend
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"

    # =============================================================================
    # Static Files - Serviti direttamente da Apache per performance
    # =============================================================================

    Alias /static /var/www/mec-previsioni/static
    <Directory /var/www/mec-previsioni/static>
        Require all granted
        Options -Indexes +FollowSymLinks

        # Cache headers per static files
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            ExpiresByType application/pdf "access plus 1 month"
        </IfModule>

        # Compressione Gzip
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml
            AddOutputFilterByType DEFLATE text/css application/javascript
            AddOutputFilterByType DEFLATE application/json
        </IfModule>
    </Directory>

    # =============================================================================
    # Security Headers - Production
    # =============================================================================

    # HSTS (HTTP Strict Transport Security) - Force HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Previene clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Previene MIME-type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Content Security Policy (CSP) - Personalizzare in base alle necessità
    # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions Policy (ex Feature-Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # =============================================================================
    # Rate Limiting (con mod_evasive o mod_security)
    # =============================================================================
    # Esempio mod_evasive (decommentare se installato)
    # <IfModule mod_evasive20.c>
    #     DOSHashTableSize 3097
    #     DOSPageCount 2
    #     DOSSiteCount 50
    #     DOSPageInterval 1
    #     DOSSiteInterval 1
    #     DOSBlockingPeriod 10
    # </IfModule>

    # =============================================================================
    # Timeouts & Limits
    # =============================================================================

    # Aumenta timeout per operazioni lunghe
    ProxyTimeout 600
    TimeOut 600

    # Limita dimensione upload (coordinato con Flask MAX_CONTENT_LENGTH)
    LimitRequestBody 104857600  # 100MB

    # =============================================================================
    # Status Balancer (Admin only)
    # =============================================================================
    # Manager per monitorare load balancer
    # Accessibile solo da IP autorizzati

    <Location /balancer-manager>
        SetHandler balancer-manager
        Require ip 127.0.0.1 ::1
        # Aggiungi altri IP autorizzati: Require ip 192.168.1.100
    </Location>

</VirtualHost>
</IfModule>
