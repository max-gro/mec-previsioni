{% extends "base.html" %}
{% block title %}Gestione Anagrafiche (File Excel){% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üìÑ Anagrafiche - File Excel</h2>
    <div class="d-flex gap-2">
      {% if current_user.is_admin() %}
      <a href="{{ url_for('anagrafiche.sync') }}" class="btn btn-secondary" title="Sincronizza con filesystem">
        üîÑ Sincronizza
      </a>
      {% endif %}
      <a href="{{ url_for('anagrafiche.create') }}" class="btn btn-primary">üì§ Carica nuovo Excel</a>
      <a href="{{ url_for('anagrafiche.nuova_marca') }}" class="btn btn-outline-secondary">‚ûï Nuova Marca</a>
    </div>
  </div>

  <!-- FILTRI -->
  
  <form class="row g-2 align-items-end mb-3" method="get" action="{{ url_for('anagrafiche.list') }}">
    <div class="col-md-2">
      <label class="form-label">Marca</label>
      <select name="marca" class="form-select">
        <option value="">Tutte</option>
        {% for m in marche_disponibili %}
          <option value="{{ m }}" {% if marca_filter==m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Anno</label>
      <select name="anno" class="form-select">
        <option value="">Tutti</option>
        {% for y in anni_disponibili %}
          <option value="{{ y }}" {% if anno_filter==y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Stato</label>
      <select name="esito" class="form-select">
        <option value="">Tutti</option>
        {% for e in ['Da processare','Processato','Errore'] %}
          <option value="{{ e }}" {% if esito_filter==e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">File</label>
      <input type="text" name="q" value="{{ q or '' }}" class="form-control" placeholder="Parte del nome file...">
    </div>
    <div class="col-md-2 d-flex  align-items-end gap-2">
      <!-- <button type="submit" class="btn btn-outline-primary w-100">üîç Filtra</button> -->
	  <button type="submit" class="btn btn-outline-primary w-100">üîç Filtra</button>
      <a class="btn btn-outline-secondary w-100" href="{{ url_for('anagrafiche.list') }}">Reset</a>
    </div>
    <!-- Mantieni lo stato di sort/order tra i filtri -->
    <input type="hidden" name="sort" value="{{ sort_by }}">
    <input type="hidden" name="order" value="{{ order }}">
  </form>

  {# eventuali filtri/alert #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for cat, msg in messages %}
          <div class="alert alert-{{ 'warning' if cat=='error' else cat }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% macro sort_link(label, col) -%}
    {%- set new_order = 'asc' if (sort_by != col or order=='desc') else 'desc' -%}
    <a href="{{ url_for('anagrafiche.list', 
                        marca=marca_filter, esito=esito_filter, anno=anno_filter, q=q,
                        sort=col, order=new_order, page=anagrafiche.page) }}" 
       class="text-decoration-none text-dark">
      {{ label }}
      {%- if sort_by==col -%}
        {{ '‚ñ≤' if order=='asc' else '‚ñº' }}
      {%- endif -%}
    </a>
  {%- endmacro %}

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-sm mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 140px;">{{ sort_link('Marca','marca') }}</th>
              <th style="width: 90px;">{{ sort_link('Anno','anno') }}</th>
              <th>{{ sort_link('File','filename') }}</th>
              <th style="width: 130px;">{{ sort_link('Stato','esito') }}</th>
              <th style="width: 140px;">{{ sort_link('Acquisizione','data_acquisizione') }}</th>
              <th style="width: 140px;">{{ sort_link('Elaborazione','data_elaborazione') }}</th>
              <th>{{ sort_link('Note','updated_at') }}</th>			  
              <th style="width: 220px;">Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for ana in anagrafiche %}
            <tr>
              <td><span class="badge text-bg-light border">{{ ana.marca }}</span></td>
			  <td><span class="badge text-bg-light border">{{ ana.anno }}</span></td>
			  
              <!-- Nome file ‚Üí Anteprima -->
              <td>
                <a href="{{ url_for('anagrafiche.preview', id=ana.id) }}" class="text-decoration-none">
                  {{ ana.filename }}
                </a>
              </td>

              <td>
                {% set badge = 'secondary' %}
                {% if ana.esito == 'Da processare' %}{% set badge='warning' %}{% endif %}
                {% if ana.esito == 'Processato' %}{% set badge='success' %}{% endif %}
                {% if ana.esito == 'Errore' %}{% set badge='danger' %}{% endif %}
                <span class="badge text-bg-{{ badge }}">{{ ana.esito }}</span>
              </td>

              <td>{{ ana.data_acquisizione.strftime('%d/%m/%Y') if ana.data_acquisizione else '-' }}</td>
              <td>{{ ana.data_elaborazione.strftime('%d/%m/%Y') if ana.data_elaborazione else '-' }}</td>
              <td class="text-truncate" style="max-width: 24rem;" title="{{ ana.note }}">{{ ana.note }}</td>

              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{{ url_for('anagrafiche.preview', id=ana.id) }}" class="btn btn-outline-info" title="Anteprima">üëÅÔ∏è</a>
                  <a href="{{ url_for('anagrafiche.download', id=ana.id) }}" class="btn btn-outline-secondary" title="Scarica">‚¨áÔ∏è</a>
                  <a href="{{ url_for('anagrafiche.edit', id=ana.id) }}" class="btn btn-outline-primary" title="Modifica note">‚úèÔ∏è</a>

                  {% if ana.esito != 'Processato' %}
                  <form method="POST" action="{{ url_for('anagrafiche.elabora', id=ana.id) }}" class="d-inline" onsubmit="return confirm('Elaborare questo file?');">
                    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                    <button type="submit" class="btn btn-outline-success" title="Elabora">‚öôÔ∏è</button>
                  </form>
                  {% endif %}

                  <!-- Elimina (apre modale globale) -->
                  <button
                    type="button"
                    class="btn btn-outline-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteModal"
                    data-delete-url="{{ url_for('anagrafiche.delete', id=ana.id) }}"
                    data-item-name="{{ ana.marca }} / {{ ana.filename }}"
                    title="Elimina"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-center p-4 text-muted">Nessun file presente.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modale globale di conferma eliminazione -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Conferma eliminazione</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <p>Vuoi eliminare <strong id="itemName"></strong>?</p>
        <div class="alert alert-warning mb-0"><small>L'operazione non √® reversibile.</small></div>
      </div>
      <div class="modal-footer">
        <form id="deleteForm" method="POST" action="">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="submit" class="btn btn-danger">Elimina</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Script che collega i pulsanti alla modale -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalEl = document.getElementById('confirmDeleteModal');
  if (!modalEl) return;
  modalEl.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    const deleteUrl = btn?.getAttribute('data-delete-url') || '';
    const itemName  = btn?.getAttribute('data-item-name') || '';
    const form = modalEl.querySelector('#deleteForm');
    const nameSpan = modalEl.querySelector('#itemName');
    if (form) form.action = deleteUrl;
    if (nameSpan) nameSpan.textContent = itemName;
  });
});
</script>
{% endblock %}
