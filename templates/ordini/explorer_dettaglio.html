{% extends "base.html" %}

{% block title %}Dettaglio Ordine {{ file_ordine.anno }} - M&C Previsioni{% endblock %}

{% block extra_css %}
<style>
    /* Info card compatta */
    .info-card {
        background: white;
        border-radius: 6px;
        padding: 12px 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 12px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px 16px;
        font-size: 0.875rem;
    }

    .info-item {
        display: flex;
        align-items: center;
    }

    .info-label {
        font-weight: 600;
        color: #6c757d;
        margin-right: 6px;
        font-size: 0.8rem;
    }

    .info-value {
        color: #212529;
    }

    /* Summary boxes */
    .summary-box {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
        color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .summary-box h6 {
        font-size: 0.875rem;
        opacity: 0.9;
        margin-bottom: 5px;
    }

    .summary-box .value {
        font-size: 1.5rem;
        font-weight: bold;
    }

    /* Tabs compatti */
    .nav-tabs {
        margin-bottom: 10px !important;
    }

    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    .nav-tabs .nav-link.active {
        color: var(--color-primary);
        border-bottom-color: var(--color-primary);
        background: transparent;
        font-weight: 600;
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: var(--color-primary-light);
    }

    /* Breadcrumb */
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 20px;
    }

    /* Badge esito */
    .badge-esito {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('ordini.list') }}">Ordini</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('ordini_explorer.index') }}">Explorer</a></li>
            <li class="breadcrumb-item active">Ordine {{ file_ordine.anno }}</li>
        </ol>
    </nav>

    <!-- Header compatto -->
    <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
            <h4 class="mb-1">üìã Ordine {{ file_ordine.anno }} <small class="text-muted">- {{ file_ordine.marca or 'N/D' }}</small></h4>
        </div>
        <div>
            {% if file_ordine.filepath %}
            <a href="{{ url_for('ordini.view', id=file_ordine.id) }}"
               class="btn btn-outline-secondary btn-sm me-2"
               target="_blank">
                üìÑ Apri PDF
            </a>
            {% endif %}
            <a href="{{ url_for('ordini_explorer.index') }}" class="btn btn-outline-secondary btn-sm">
                ‚Üê Explorer
            </a>
        </div>
    </div>

    <!-- Informazioni Ordine compatte a griglia -->
    <div class="info-card">
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Anno:</span>
                <span class="info-value">{{ file_ordine.anno }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Marca:</span>
                <span class="info-value">{{ file_ordine.marca or '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Data Ordine:</span>
                <span class="info-value">{{ file_ordine.data_ordine.strftime('%d/%m/%Y') if file_ordine.data_ordine else '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Buyer:</span>
                <span class="info-value">{{ file_ordine.buyer.controparte if file_ordine.buyer else '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Seller:</span>
                <span class="info-value">{{ file_ordine.seller.controparte if file_ordine.seller else '-' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Esito:</span>
                <span class="badge badge-esito bg-{{ 'success' if file_ordine.esito == 'Processato' else 'warning' if file_ordine.esito == 'Da processare' else 'danger' }}">
                    {{ file_ordine.esito }}
                </span>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="dettaglioTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="righe-tab" data-bs-toggle="tab" data-bs-target="#righe" type="button">
                üì¶ Righe Ordine ({{ totale_righe }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="aggregato-tab" data-bs-toggle="tab" data-bs-target="#aggregato" type="button">
                üìä Aggregato per Modello
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dettaglioTabsContent">
        <!-- TAB 1: RIGHE ORDINE -->
        <div class="tab-pane fade show active" id="righe" role="tabpanel">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üì¶ Righe Ordine</h5>
                </div>
                <div class="card-body">
                    <!-- Riepilogo -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="summary-box">
                                <h6>Totale Righe</h6>
                                <div class="value">{{ totale_righe }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-box">
                                <h6>Quantit√† Totale</h6>
                                <div class="value">{{ totale_qta|number_format }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-box">
                                <h6>Importo Totale</h6>
                                <div class="value">‚Ç¨ {{ "%.2f"|format(totale_importo) }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabella Righe -->
                    {% if righe %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Cod. Modello</th>
                                    <th>Nome Modello</th>
                                    <th>Brand</th>
                                    <th>Item</th>
                                    <th>EAN</th>
                                    <th class="text-center">Qt√†</th>
                                    <th class="text-end">Prezzo ‚Ç¨</th>
                                    <th class="text-end">Importo ‚Ç¨</th>
                                    <th class="text-center">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for riga in righe %}
                                <tr>
                                    <td><strong>{{ riga.cod_modello }}</strong></td>
                                    <td><small>{{ riga.nome_modello or riga.nome_modello_it or '-' }}</small></td>
                                    <td>{{ riga.brand or '-' }}</td>
                                    <td><small>{{ riga.item or '-' }}</small></td>
                                    <td><small>{{ riga.ean or '-' }}</small></td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">{{ riga.qta or 0 }}</span>
                                    </td>
                                    <td class="text-end">
                                        {% if riga.prezzo_eur %}
                                        ‚Ç¨ {{ "%.2f"|format(riga.prezzo_eur) }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if riga.importo_eur %}
                                        <strong>‚Ç¨ {{ "%.2f"|format(riga.importo_eur) }}</strong>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('previsioni.index') }}?modello={{ riga.cod_modello }}"
                                           class="btn btn-sm btn-outline-primary"
                                           title="Vai a Previsioni">
                                            üìà
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="5">TOTALE</th>
                                    <th class="text-center">{{ totale_qta|number_format }}</th>
                                    <th></th>
                                    <th class="text-end">‚Ç¨ {{ "%.2f"|format(totale_importo) }}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        Nessuna riga ordine trovata per questo file.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- TAB 2: AGGREGATO PER MODELLO -->
        <div class="tab-pane fade" id="aggregato" role="tabpanel">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üìä Aggregato per Modello</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Riepilogo quantit√† e importi per modello (ordinato per importo decrescente).
                    </p>

                    {% if aggregato %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Cod. Modello</th>
                                    <th>Marca</th>
                                    <th>Nome Modello</th>
                                    <th class="text-center">N. Righe</th>
                                    <th class="text-end">Qt√† Totale</th>
                                    <th class="text-end">Importo Totale ‚Ç¨</th>
                                    <th class="text-center">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for agg in aggregato %}
                                <tr>
                                    <td><strong>{{ agg.cod_modello }}</strong></td>
                                    <td>{{ agg.marca or '-' }}</td>
                                    <td><small>{{ agg.nome_modello or '-' }}</small></td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">{{ agg.n_righe }}</span>
                                    </td>
                                    <td class="text-end">{{ agg.qta_totale|number_format }}</td>
                                    <td class="text-end">
                                        <strong>‚Ç¨ {{ "%.2f"|format(agg.importo_totale) }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('previsioni.index') }}?modello={{ agg.cod_modello }}"
                                           class="btn btn-sm btn-primary"
                                           title="Vai a Previsioni">
                                            üìà Previsioni
                                        </a>
                                        <a href="{{ url_for('anagrafiche_catalogo.dettaglio_modello', cod_modello=agg.cod_modello) }}"
                                           class="btn btn-sm btn-outline-secondary"
                                           title="Vai a Catalogo">
                                            üì¶
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="4">TOTALE</th>
                                    <th class="text-end">{{ totale_qta|number_format }}</th>
                                    <th class="text-end">‚Ç¨ {{ "%.2f"|format(totale_importo) }}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        Nessun dato aggregato disponibile.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
