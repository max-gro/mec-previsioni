{% extends "base.html" %}

{% block title %}File Rotture{% endblock %}

{% block extra_css %}
<style>
.sortable-header {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
}
.sortable-header:hover {
    background-color: #dee2e6 !important;
}
.sort-icon {
    font-size: 0.8em;
    margin-left: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>üîß File Rotture</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">File Rotture</li>
                </ol>
            </nav>
            <p class="text-muted">
                Upload ed elaborazione file Excel rotture componenti
                {% if total_count is defined and filtered_count is defined %}
                    {% if filtered_count < total_count %}
                        <span class="badge bg-info ms-2">{{ filtered_count }} di {{ total_count }} risultati</span>
                    {% else %}
                        <span class="badge bg-secondary ms-2">{{ total_count }} risultati</span>
                    {% endif %}
                {% endif %}
            </p>
        </div>
        <div class="col-md-6 text-end">
            {% if current_user.is_admin() %}
            <a href="{{ url_for('rotture.sync') }}" class="btn btn-secondary me-2" title="Sincronizza con filesystem">
                üîÑ Sincronizza
            </a>
            <a href="{{ url_for('rotture.create') }}" class="btn btn-primary">
                ‚ûï Carica Nuove Rotture
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filtri -->
    <div class="row mb-4">
        <div class="col-md-12">
            <!-- <div class="card shadow-sm"> -->
                <div class="card-body">
                    <form method="GET" action="{{ url_for('rotture.list') }}" class="row g-3">
                        <input type="hidden" name="sort" value="{{ sort_by }}">
                        <input type="hidden" name="order" value="{{ order }}">
                        <div class="col-md-2">
                            <label class="form-label">Anno</label>
                            <select name="anno" class="form-select">
                                <option value="">Tutti</option>
                                {% for anno in anni_disponibili %}
                                <option value="{{ anno }}" {% if anno_filter == anno %}selected{% endif %}>{{ anno }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Stato</label>
                            <select name="esito" class="form-select">
                                <option value="">Tutti</option>
                                <option value="Da processare" {% if esito_filter == 'Da processare' %}selected{% endif %}>Da processare</option>
                                <option value="Processato" {% if esito_filter == 'Processato' %}selected{% endif %}>Processato</option>
                                <option value="Errore" {% if esito_filter == 'Errore' %}selected{% endif %}>Errore</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end gap-2">
                            <button type="submit" class="btn btn-outline-primary">üîç Filtra</button>
                            <a href="{{ url_for('rotture.list') }}" class="btn btn-outline-secondary">‚úï Reset</a>
                        </div>
                    </form>
                </div>
            <!-- </div> -->
        </div>
    </div>

    <!-- Tabella -->
    <div class="card shadow-sm">
        <div class="card-body">
            {% if rotture.items %}

            {# Macro per link ordinamento #}
            {% macro sort_link(column, label) %}
                <a href="{{ url_for('rotture.list',
                           page=1,
                           anno=anno_filter,
                           esito=esito_filter,
                           sort=column,
                           order='desc' if sort_by == column and order == 'asc' else 'asc') }}"
                   class="text-decoration-none text-dark d-flex align-items-center">
                    {{ label }}
                    {% if sort_by == column %}
                        <span class="sort-icon">
                            {% if order == 'asc' %}
                                <strong>‚ñ≤</strong>
                            {% else %}
                                <strong>‚ñº</strong>
                            {% endif %}
                        </span>
                    {% else %}
                        <span class="sort-icon text-muted">‚áÖ</span>
                    {% endif %}
                </a>
            {% endmacro %}

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="sortable-header">{{ sort_link('anno', 'Anno') }}</th>
                            <th class="sortable-header">{{ sort_link('filename', 'File') }}</th>
                            <th class="sortable-header">{{ sort_link('data_acquisizione', 'Acquisizione') }}</th>
                            <th class="sortable-header">{{ sort_link('data_elaborazione', 'Elaborazione') }}</th>
                            <th class="sortable-header">{{ sort_link('esito', 'Stato') }}</th>
                            <th>Elaborazioni</th>
                            <th>Percorso</th>
                            <th>Note</th>
                            {% if current_user.is_admin() %}
                            <th class="text-end">Azioni</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for rottura in rotture.items %}
                        <tr>
                            <td><strong>{{ rottura.anno }}</strong></td>
                            <td>
                                <a href="{{ url_for('rotture.download', id=rottura.id) }}" class="text-decoration-none" title="Download">
                                    üìÑ {{ rottura.filename }}
                                </a>
                            </td>
                            <td>{{ rottura.data_acquisizione|datetime_format }}</td>
                            <td>
                                {% if rottura.data_elaborazione %}
                                {{ rottura.data_elaborazione|datetime_format }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if rottura.esito == 'Processato' %}
                                <span class="badge bg-success">‚úÖ {{ rottura.esito }}</span>
                                {% elif rottura.esito == 'Errore' %}
                                <span class="badge bg-danger">‚ùå {{ rottura.esito }}</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">‚è≥ {{ rottura.esito }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('rotture.elaborazioni_list', id=rottura.id) }}" class="btn btn-sm btn-outline-info" title="Vedi elaborazioni">
                                    üìä Dettagli
                                </a>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {% if rottura.esito == 'Processato' %}
                                    üìÅ OUTPUT/rotture
                                    {% else %}
                                    üìÇ INPUT/rotture
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                {% if rottura.note %}
                                <span class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ rottura.note }}">
                                    {{ rottura.note }}
                                </span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            {% if current_user.is_admin() %}
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <!-- Bottone Elabora (solo se Da processare o Errore) -->
                                    {% if rottura.esito != 'Processato' %}
                                    <form method="POST" action="{{ url_for('rotture.elabora', id=rottura.id) }}" style="display: inline;" 
                                          onsubmit="return confirm('Sei sicuro di voler elaborare questo file?');">
                                        <button type="submit" class="btn btn-outline-success" title="Elabora file">
                                            ‚öôÔ∏è
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    <!-- Bottone Download -->
                                    <a href="{{ url_for('rotture.download', id=rottura.id) }}" class="btn btn-outline-info" title="Download">
                                        ‚¨á
                                    </a>
                                    
                                    <!-- Bottone Modifica -->
                                    <a href="{{ url_for('rotture.edit', id=rottura.id) }}" class="btn btn-outline-primary" title="Modifica">
                                        ‚úèÔ∏è
                                    </a>
                                    
                                    <!-- Bottone Elimina -->
                                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ rottura.id }}" title="Elimina">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginazione -->
            {% if rotture.pages > 1 %}
            <nav aria-label="Navigazione pagine">
                <ul class="pagination justify-content-center mt-4">
                    <li class="page-item {% if not rotture.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('rotture.list', page=rotture.prev_num, anno=anno_filter, esito=esito_filter, sort=sort_by, order=order) }}">Precedente</a>
                    </li>

                    {% for page_num in rotture.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == rotture.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('rotture.list', page=page_num, anno=anno_filter, esito=esito_filter, sort=sort_by, order=order) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {% if not rotture.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('rotture.list', page=rotture.next_num, anno=anno_filter, esito=esito_filter, sort=sort_by, order=order) }}">Successiva</a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <p class="text-muted">Nessun file rottura trovato.</p>
                {% if current_user.is_admin() %}
                <a href="{{ url_for('rotture.create') }}" class="btn btn-primary">Carica il primo file</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Legenda -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="card-title">üìñ Legenda Stati</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <span class="badge bg-warning text-dark">‚è≥ Da processare</span>
                            <p class="small mt-2">File caricato in INPUT/rotture, in attesa di elaborazione</p>
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-success">‚úÖ Processato</span>
                            <p class="small mt-2">File elaborato con successo e spostato in OUTPUT/rotture</p>
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-danger">‚ùå Errore</span>
                            <p class="small mt-2">Errore durante elaborazione, file rimasto in INPUT/rotture</p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- <h6>üîß Azioni disponibili:</h6> -->
                    <!-- <ul class="small mb-0"> -->
                        <!-- <li><strong>üîÑ Sincronizza:</strong> Scansiona le cartelle INPUT/rotture e OUTPUT/rotture e aggiunge file non presenti nel database</li> -->
                        <!-- <li><strong>‚öôÔ∏è Elabora:</strong> Elabora il file Excel (solo per stati "Da processare" ed "Errore")</li> -->
                        <!-- <li><strong>üì• Download:</strong> Scarica il file Excel</li> -->
                        <!-- <li><strong>‚úèÔ∏è Modifica:</strong> Modifica metadati e note</li> -->
                        <!-- <li><strong>üóëÔ∏è Elimina:</strong> Elimina file e record database</li> -->
                    <!-- </ul> -->
					
					<!-- Info Box -->
					<div class="row mt-4">
						<div class="col-md-12">
							<div class="alert alert-info">
								<h6 class="alert-heading">üîß Azioni disponibili</h6>
								<ul class="small mb-0">
									<li><strong>üîÑ Sincronizza:</strong> Scansiona le cartelle INPUT/rotture e OUTPUT/rotture e aggiunge file non presenti nel database</li>
									<li><strong>‚ûï Carica:</strong> Aggiunge un nuovo file Excel</li>									
									<li><strong>‚öôÔ∏è Elabora:</strong> Elabora il file Excel (solo per stati "Da processare" ed "Errore")</li>
									<li><strong>‚¨á Download:</strong> Scarica il file Excel</li>
									<li><strong>‚úèÔ∏è Modifica:</strong> Modifica metadati e note</li>
									<li><strong>üóëÔ∏è Elimina:</strong> Elimina file e record database</li>								
									<li><strong>Struttura cartelle:</strong> INPUT/po/anno/ (Da processare, Errore) ‚Üí OUTPUT/po/anno/ (Processato)</li>
								</ul>
							</div>
						</div>
					</div>					
					
                </div>
            </div>
        </div>
    </div>
	
</div>

<!-- ‚úÖ MODAL FUORI DAL LOOP - NIENTE PI√ô FLICKERING! -->
{% if rotture.items and current_user.is_admin() %}
{% for rottura in rotture.items %}
<div class="modal fade" id="deleteModal{{ rottura.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ rottura.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel{{ rottura.id }}">Conferma Eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Sei sicuro di voler eliminare il file <strong>{{ rottura.filename }}</strong> (Anno {{ rottura.anno }})?
                <br><br>
                Verr√† eliminato sia il record dal database che il file fisico.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form method="POST" action="{{ url_for('rotture.delete', id=rottura.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Elimina</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

{% endblock %}